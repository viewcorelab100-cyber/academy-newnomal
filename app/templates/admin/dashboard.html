{% extends "base.html" %}

{% block title %}ëŒ€ì‹œë³´ë“œ - Academy Builder{% endblock %}

{% block content %}
<div x-data="dashboard()" class="h-screen flex bg-[#F4F6F9] overflow-hidden">
    <!-- Floating Sidebar -->
    <aside class="w-20 lg:w-64 m-4 mr-0 bg-white rounded-3xl flex flex-col shadow-[0_8px_30px_rgb(0,0,0,0.04)] border border-white z-20 shrink-0 transition-all duration-300">
        <!-- Logo Area -->
        <div class="p-6 flex items-center justify-center lg:justify-start gap-3">
            <div class="w-10 h-10 bg-slate-900 rounded-xl flex items-center justify-center shadow-lg shadow-slate-900/20 shrink-0">
                <i data-lucide="layout-grid" class="w-5 h-5 text-white"></i>
            </div>
            <div class="hidden lg:block overflow-hidden whitespace-nowrap">
                <h1 class="font-bold text-slate-900 leading-tight">Academy</h1>
                <p class="text-[10px] font-bold text-slate-400 tracking-wider uppercase">Manager</p>
            </div>
        </div>
        
        <!-- Navigation -->
        <nav class="flex-1 px-3 py-4 space-y-1 overflow-y-auto custom-scrollbar">
            <p class="px-4 text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2 hidden lg:block">Main</p>
            
            <a href="/admin/dashboard" class="flex items-center gap-3 px-3 py-3 rounded-xl bg-slate-50 text-slate-900 font-bold shadow-sm transition-all group">
                <i data-lucide="home" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                <span class="hidden lg:block">ëŒ€ì‹œë³´ë“œ</span>
            </a>
            
            <a href="/admin/features" class="flex items-center gap-3 px-3 py-3 rounded-xl text-slate-500 hover:bg-slate-50 hover:text-slate-900 font-medium transition-all group">
                <i data-lucide="package" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                <span class="hidden lg:block">ê¸°ëŠ¥ ë¹Œë”</span>
            </a>

            <div class="my-4 border-t border-slate-100 hidden lg:block"></div>
            <p class="px-4 text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2 hidden lg:block">Installed</p>
            
            <!-- Dynamic Features -->
            <template x-for="feature in enabledFeatures" :key="feature.code">
                <a :href="`/admin/${feature.code}`" class="flex items-center gap-3 px-3 py-3 rounded-xl text-slate-500 hover:bg-slate-50 hover:text-slate-900 font-medium transition-all group">
                    <div class="w-5 h-5 flex items-center justify-center rounded-lg bg-slate-100 text-slate-400 group-hover:bg-white group-hover:text-slate-600 transition-colors">
                        <i :data-lucide="feature.icon" class="w-3.5 h-3.5"></i>
                    </div>
                    <span class="hidden lg:block text-sm" x-text="feature.name"></span>
                </a>
            </template>
        </nav>
        
        <!-- User Profile -->
        <div class="p-3 mt-auto">
            <button @click="logout()" class="w-full flex items-center gap-3 p-3 rounded-2xl hover:bg-red-50 text-slate-500 hover:text-red-500 transition-all group">
                <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center shrink-0 group-hover:bg-white">
                    <i data-lucide="log-out" class="w-4 h-4"></i>
                </div>
                <div class="hidden lg:block text-left overflow-hidden">
                    <p class="text-xs font-bold text-slate-900 group-hover:text-red-600">ë¡œê·¸ì•„ì›ƒ</p>
                    <p class="text-[10px] text-slate-400">ì„¸ì…˜ ì¢…ë£Œ</p>
                </div>
            </button>
        </div>
    </aside>
    
    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto p-4 lg:p-8 custom-scrollbar">
        <!-- Header -->
        <header class="flex flex-col lg:flex-row lg:items-center justify-between gap-4 mb-8">
            <div>
                <h2 class="text-3xl font-bold text-slate-900 tracking-tight">ì•ˆë…•í•˜ì„¸ìš”, ê´€ë¦¬ìë‹˜ ğŸ‘‹</h2>
                <p class="text-slate-500 mt-1" x-text="academyName"></p>
            </div>
            <div class="flex items-center gap-3">
                <div class="bg-white px-4 py-2 rounded-xl shadow-sm border border-slate-100 flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                    <span class="text-sm font-bold text-slate-600">ìš´ì˜ ì¤‘</span>
                </div>
                <a href="/admin/features" class="bg-slate-900 hover:bg-slate-800 text-white px-5 py-2.5 rounded-xl font-bold shadow-lg shadow-slate-900/20 flex items-center gap-2 transition-all hover:-translate-y-0.5 active:translate-y-0">
                    <i data-lucide="plus" class="w-4 h-4"></i>
                    <span>ê¸°ëŠ¥ ì¶”ê°€</span>
                </a>
            </div>
        </header>
        
        <!-- Bento Grid Layout -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            
            <!-- Stats Module: Students (Large) -->
            <div class="bg-white p-6 rounded-3xl shadow-[0_2px_20px_rgb(0,0,0,0.04)] border border-slate-100 hover-lift col-span-1 md:col-span-2 relative overflow-hidden group">
                <div class="absolute right-0 top-0 w-32 h-32 bg-blue-50 rounded-bl-[100px] -mr-4 -mt-4 transition-transform group-hover:scale-110"></div>
                <div class="relative z-10">
                    <div class="flex items-center gap-3 mb-2">
                        <div class="p-2 bg-blue-100 text-blue-600 rounded-lg">
                            <i data-lucide="users" class="w-5 h-5"></i>
                        </div>
                        <span class="text-sm font-bold text-slate-500 uppercase tracking-wider">ì „ì²´ í•™ìƒ</span>
                    </div>
                    <div class="flex items-end gap-2 mt-4">
                        <span class="text-5xl font-bold text-slate-900" x-text="stats.totalStudents"></span>
                        <span class="text-lg font-bold text-slate-400 mb-1">ëª…</span>
                    </div>
                    <p class="text-sm text-slate-400 mt-2 font-medium">+4ëª… (ì´ë²ˆ ë‹¬)</p>
                </div>
            </div>
            
            <!-- Stats Module: Attendance -->
            <div class="bg-white p-6 rounded-3xl shadow-[0_2px_20px_rgb(0,0,0,0.04)] border border-slate-100 hover-lift flex flex-col justify-between group">
                <div class="flex justify-between items-start">
                    <div class="p-2 bg-green-100 text-green-600 rounded-lg">
                        <i data-lucide="check-circle" class="w-5 h-5"></i>
                    </div>
                    <span class="text-xs font-bold bg-green-50 text-green-600 px-2 py-1 rounded-md">Today</span>
                </div>
                <div>
                    <span class="text-sm font-bold text-slate-500 block mb-1">ì˜¤ëŠ˜ ì¶œì„</span>
                    <span class="text-3xl font-bold text-slate-900" x-text="stats.todayAttendance"></span>
                </div>
            </div>
            
            <!-- Stats Module: Revenue -->
            <div class="bg-white p-6 rounded-3xl shadow-[0_2px_20px_rgb(0,0,0,0.04)] border border-slate-100 hover-lift flex flex-col justify-between group">
                <div class="flex justify-between items-start">
                    <div class="p-2 bg-purple-100 text-purple-600 rounded-lg">
                        <i data-lucide="credit-card" class="w-5 h-5"></i>
                    </div>
                    <span class="text-xs font-bold bg-purple-50 text-purple-600 px-2 py-1 rounded-md">Month</span>
                </div>
                <div>
                    <span class="text-sm font-bold text-slate-500 block mb-1">ì´ë²ˆ ë‹¬ ìˆ˜ë‚©</span>
                    <span class="text-xl font-bold text-slate-900 tracking-tight" x-text="formatCurrency(stats.monthlyRevenue)"></span>
                </div>
            </div>
        </div>

        <!-- Quick Actions Grid -->
        <h3 class="text-lg font-bold text-slate-900 mb-4 px-1 flex items-center gap-2">
            <i data-lucide="zap" class="w-5 h-5 text-yellow-500 fill-current"></i>
            ë¹ ë¥¸ ì‘ì—…
        </h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <a href="/admin/students" class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 hover:border-blue-500 hover:shadow-md transition-all group flex flex-col items-center justify-center gap-3 text-center">
                <div class="w-12 h-12 bg-blue-50 text-blue-600 rounded-xl flex items-center justify-center group-hover:scale-110 transition-transform">
                    <i data-lucide="user-plus" class="w-6 h-6"></i>
                </div>
                <span class="font-bold text-slate-700 text-sm group-hover:text-blue-600">í•™ìƒ ë“±ë¡</span>
            </a>
            
            <a href="/admin/attendance" class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 hover:border-green-500 hover:shadow-md transition-all group flex flex-col items-center justify-center gap-3 text-center">
                <div class="w-12 h-12 bg-green-50 text-green-600 rounded-xl flex items-center justify-center group-hover:scale-110 transition-transform">
                    <i data-lucide="qr-code" class="w-6 h-6"></i>
                </div>
                <span class="font-bold text-slate-700 text-sm group-hover:text-green-600">QR ì¶œì„</span>
            </a>
            
            <a href="/admin/billing" class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 hover:border-purple-500 hover:shadow-md transition-all group flex flex-col items-center justify-center gap-3 text-center">
                <div class="w-12 h-12 bg-purple-50 text-purple-600 rounded-xl flex items-center justify-center group-hover:scale-110 transition-transform">
                    <i data-lucide="file-plus" class="w-6 h-6"></i>
                </div>
                <span class="font-bold text-slate-700 text-sm group-hover:text-purple-600">ì²­êµ¬ì„œ</span>
            </a>
            
            <a href="/admin/notices" class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 hover:border-red-500 hover:shadow-md transition-all group flex flex-col items-center justify-center gap-3 text-center">
                <div class="w-12 h-12 bg-red-50 text-red-600 rounded-xl flex items-center justify-center group-hover:scale-110 transition-transform">
                    <i data-lucide="megaphone" class="w-6 h-6"></i>
                </div>
                <span class="font-bold text-slate-700 text-sm group-hover:text-red-600">ê³µì§€ ì‘ì„±</span>
            </a>
        </div>
        
        <!-- Recent Activity Feed -->
        <div class="bg-white rounded-3xl shadow-[0_2px_20px_rgb(0,0,0,0.04)] border border-slate-100 p-6">
            <h3 class="text-lg font-bold text-slate-900 mb-6 flex items-center gap-2">
                <i data-lucide="activity" class="w-5 h-5 text-slate-400"></i>
                ìµœê·¼ í™œë™
            </h3>
            <div class="space-y-6 relative before:absolute before:left-[19px] before:top-2 before:h-full before:w-[2px] before:bg-slate-100">
                <template x-for="activity in recentActivity" :key="activity.id">
                    <div class="flex gap-4 relative">
                        <div class="w-10 h-10 rounded-xl bg-white border-2 border-slate-100 flex items-center justify-center shrink-0 z-10">
                            <i :data-lucide="activity.icon" class="w-4 h-4 text-slate-500"></i>
                        </div>
                        <div class="pt-1">
                            <p class="text-sm font-bold text-slate-800" x-text="activity.title"></p>
                            <p class="text-xs font-medium text-slate-400 mt-1" x-text="activity.time"></p>
                        </div>
                    </div>
                </template>
            </div>
        </div>
        
        <!-- Bottom Padding -->
        <div class="h-8"></div>
    </main>
</div>

<script>
function dashboard() {
    return {
        academyName: 'ë¡œë”© ì¤‘...',
        enabledFeatures: [],
        stats: {
            totalStudents: 0,
            todayAttendance: 0,
            monthlyRevenue: 0,
            pendingHomework: 0
        },
        recentActivity: [],
        
        async init() {
            await this.loadFeatures();
            await this.loadStats();
            lucide.createIcons();
        },
        
        async loadFeatures() {
            const token = localStorage.getItem('token');
            if (!token) return window.location.href = '/admin/login';
            
            try {
                const response = await fetch('/api/features/academy', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const features = await response.json();
                    this.enabledFeatures = features.filter(f => f.enabled).map(f => {
                        const catalog = {
                            'students': { name: 'í•™ìƒ ê´€ë¦¬', icon: 'users' },
                            'attendance': { name: 'ì¶œê²° ê´€ë¦¬', icon: 'calendar-check' },
                            'billing': { name: 'ì²­êµ¬ ë° ê²°ì œ', icon: 'credit-card' },
                            'homework': { name: 'ìˆ™ì œ ê´€ë¦¬', icon: 'book-open' },
                            'notices': { name: 'ê³µì§€ì‚¬í•­', icon: 'megaphone' },
                            'counseling': { name: 'ìƒë‹´ ê¸°ë¡', icon: 'message-circle' }
                        };
                        return { code: f.feature_code, ...catalog[f.feature_code] };
                    });
                }
            } catch (error) {
                console.error('Failed to load features:', error);
            }
        },
        
        async loadStats() {
            const token = localStorage.getItem('token');
            if (!token) return window.location.href = '/admin/login';
            
            try {
                const response = await fetch('/api/dashboard/stats', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    this.academyName = data.academy_name;
                    this.stats = data.stats;
                    this.recentActivity = data.recent_activity;
                } else {
                    // Fallback to mock data if API fails
                    this.academyName = 'í•™ì›';
                    this.stats = {
                        totalStudents: 0,
                        todayAttendance: 0,
                        monthlyRevenue: 0
                    };
                    this.recentActivity = [];
                }
            } catch (error) {
                console.error('Failed to load dashboard stats:', error);
                // Fallback to mock data
                this.academyName = 'í•™ì›';
                this.stats = {
                    totalStudents: 0,
                    todayAttendance: 0,
                    monthlyRevenue: 0
                };
                this.recentActivity = [];
            }
        },
        
        formatCurrency(amount) {
            return new Intl.NumberFormat('ko-KR', {
                style: 'currency',
                currency: 'KRW'
            }).format(amount);
        },
        
        logout() {
            localStorage.removeItem('token');
            window.location.href = '/';
        }
    }
}
</script>
{% endblock %}
